import groovy.xml.MarkupBuilder
apply plugin: 'com.android.application'

android {
    compileSdkVersion 21
    buildToolsVersion "21.1.1"
    defaultConfig {
        applicationId "com.octo.app"
        minSdkVersion 18
        targetSdkVersion 21
        versionCode appVersionCode
        versionName appVersionName
    }

    signingConfigs {
        production {
            storeFile file('../keystore/production.jks')
            storePassword 'testocto'
            keyAlias 'com.octo Test'
            keyPassword 'testocto'
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.production
        }
    }

    productFlavors {
        brandA {
            applicationId "com.octo.app.a"
        }
        brandB {
            applicationId "com.octo.app.b"
        }
    }
}

dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])

    // We don't need this anymore
//    wearApp project(':wear')
    compile 'com.google.android.gms:play-services:6.1.71'
}

project.afterEvaluate {
    android.applicationVariants.all { variant ->

        if (variant.buildType.name == 'release') {
            tasks["generate${variant.name.capitalize()}Assets"].dependsOn(":wear:assemble${variant.name.capitalize()}")

            variant.outputs.each { output ->
                task("handle${variant.name.capitalize()}WearDesc") << { // Edit the Wear Description XML file
                    def apkFileName = "wear-${variant.flavorName}-${variant.buildType.name}.apk"
                    File wearDescFile = file("${output.processResources.resDir}/xml/wear_desc.xml")
                    String content = wearDescFile.getText('UTF-8')
                    content = content.replaceAll(/APPICATION_ID/, "${variant.mergedFlavor.applicationId}")
                    content = content.replaceAll(/VERSION_CODE/, "${variant.mergedFlavor.versionCode}")
                    content = content.replaceAll(/VERSION_NAME/, "${variant.mergedFlavor.versionName}")
                    content = content.replaceAll(/WEAR_BUILD/, apkFileName)
                    wearDescFile.write(content, 'UTF-8')
                }
                output.processManifest.dependsOn("handle${variant.name.capitalize()}WearDesc")

                output.assemble << { // Clean the assets folder of all apk
                    ant.delete(includeEmptyDirs: 'true') {
                        fileset(dir: file('./src/main/assets/'), includes: '*.apk')
                    }
                }
            }
        }
    }

    task("lol") << {
        project.rootProject.findProject(":wear").android.applicationVariants.all { variant ->
            addWearableXmlDescriptionFile variant
        }
    }
}

def addWearableXmlDescriptionFile(variant) {
    variant.outputs.each { output ->
        def xmlWritter = new StringWriter()
        def xml = new MarkupBuilder(xmlWritter)
        xml.setDoubleQuotes true
        xml.mkp.xmlDeclaration(version: "1.0", encoding: "utf-8")
        xml.wearableApp(package: variant.mergedFlavor.applicationId) {
            versionCode(variant.mergedFlavor.versionCode)
            versionName(variant.mergedFlavor.versionName)
            path(output.outputFile.name)
        }
        println xmlWritter
    }
}
